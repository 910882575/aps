# Instruction

Instruction on data format & configuration rules.

## Data Preparation

### Acoustic Model

1. [Kaldi](../aps/loader/am/kaldi.py) dataloader requires `feats.scp`, `utt2num_frames`, `token`.

    `feats.scp` and `utt2num_frames` are generated by [Kaldi](https://github.com/kaldi-asr/kaldi) toolkit, e.g., `steps/make_{mfcc,fbank}.sh`, while `token` is tokenized from the transcriptions and it looks like:
    ```
    BAC009S0002W0126 101 3 29 812 1742 2554 1675 3931 3828
    BAC009S0002W0127 3972 67 414 90 9 2106 1157 1105 2146 724 703 29 3 2886 765 1122 575 8 78 45 810
    BAC009S0002W0128 703 427 276 29 3968 3555 765 1122 1210 31
    BAC009S0002W0129 703 427 3 29 1116 1939 1193 489 2110 1383 491 2581 1621 1785 67 3968 3555
    BAC009S0002W0130 3544 1622 3832 3356 1622 2808 2860 3984 282 526 2996 1779
    BAC009S0002W0131 1699 2688 332 67 1787 1208 2554 889 381
    ```
    `utt2num_frames` is used to sort utterances to form the mini-batch that minimized the padding size.

2. [Wave]([Kaldi](../aps/loader/am/wav.py)) dataloader requires `wav.scp`, `utt2dur`, `token`. 

    `wav.scp` follows the definition in [Kaldi](https://github.com/kaldi-asr/kaldi) and `utt2dur` prescribes the duration of each utterance, e.g.,:
    ```
    BAC009S0002W0126        2.5760
    BAC009S0002W0127        5.8900
    BAC009S0002W0128        3.3930
    BAC009S0002W0129        6.1360
    BAC009S0002W0130        4.1300
    BAC009S0002W0131        4.4060
    ```
    The `token` is same as the one used in `am_kaldi` dataloader.

### Enhancement/Separation Model

1. [Chunk](../aps/loader/ss/chunk.py) dataloader only requires several wave script, e.g., `mix.scp,spk{1,2}.scp` for separation tasks. Each one follows [Kaldi](https://github.com/kaldi-asr/kaldi)'s format. 

2. [Online](../aps/loader/ss/online.py) dataloader simulates and splits the audio on-the-fly and it only requires one configuration script for data simulation. The format of each line follows the pattern `<key> <command-options>`. See [wav_simulate.py](https://github.com/funcwj/setk/blob/master/scripts/sptk/wav_simulate.py) for details of the `<command-options>`:
```
usage: wav_simulate.py [-h] [--dump-ref-dir DUMP_REF_DIR] --src-spk SRC_SPK
                       [--src-rir SRC_RIR] [--src-sdr SRC_SDR] [--src-begin SRC_BEGIN]
                       [--point-noise POINT_NOISE] [--point-noise-rir POINT_NOISE_RIR]
                       [--point-noise-snr POINT_NOISE_SNR]
                       [--point-noise-begin POINT_NOISE_BEGIN]
                       [--point-noise-offset POINT_NOISE_OFFSET]
                       [--point-noise-repeat POINT_NOISE_REPEAT]
                       [--isotropic-noise ISOTROPIC_NOISE]
                       [--isotropic-noise-snr ISOTROPIC_NOISE_SNR]
                       [--isotropic-noise-offset ISOTROPIC_NOISE_OFFSET]
                       [--dump-channel DUMP_CHANNEL] [--norm-factor NORM_FACTOR]
                       [--sr SR]
                       mix
```

## Experimental Configurations

Almost all the hyper-parameters are in the yaml configuration files and the followings are allowed keys:

* `nnet` and `nnet_conf`: Name of the networks and it's parameters. The supported networks are available in [aps/asr/\_\_init\_\_.py](../aps/asr/\_\_init\_\_.py) and [aps/sep/\_\_init\_\_.py](../aps/sep/\_\_init\_\_.py)

* `task` and `task_conf`: Name of the task and it's parameters. The supported tasks are in [aps/task/\_\_init\_\_.py](../aps/task/\_\_init\_\_.py)

* `data_conf`: Parameters for dataloader. The followings are examples of the [wave]([Kaldi](../aps/loader/am/wav.py)) dataloader

    ```yaml
    data_conf:
      fmt: "am_wav"
      loader:
        max_token_num: 400
        adapt_token_num: 150
        max_dur: 30 # (s)
        min_dur: 0.4 # (s)
        adapt_dur: 10 # (s)
      train:
        wav_scp: "data/aishell_v1/train/wav.scp"
        utt2dur: "data/aishell_v1/train/utt2dur"
        token: "data/aishell_v1/train/token"
      valid:
        wav_scp: "data/aishell_v1/dev/wav.scp"
        utt2dur: "data/aishell_v1/dev/utt2dur"
        token: "data/aishell_v1/dev/token"
    ```
    and [chunk](../aps/loader/ss/chunk.py) dataloader:

    ```yaml
    data_conf:
      fmt: "ss_chunk"
      loader:
        chunk_size: 32000
        sr: 8000
      train:
        mix_scp: "data/wsj0_2mix/tr/mix.scp"
        ref_scp: "data/wsj0_2mix/tr/spk1.scp,data/wsj0_2mix/tr/spk2.scp"
      valid:
        mix_scp: "data/wsj0_2mix/cv/mix.scp"
        ref_scp: "data/wsj0_2mix/cv/spk1.scp,data/wsj0_2mix/cv/spk2.scp"
    ```

* `trainer_conf`: Parameters for `Trainer` class, including learning rate and schedule sampling scheduler. For example:
    ```yaml
    trainer_conf:
      optimizer: "adam"
      optimizer_kwargs:
          lr: 1.0e-3
          weight_decay: 1.0e-5
      lr_scheduler: "reduce_lr"
      lr_scheduler_kwargs:
          min_lr: 1.0e-8
          patience: 1
          factor: 0.5
      ss_scheduler: "linear"
      ss_scheduler_kwargs:
          ssr: 0.2
          epoch_beg: 10
          epoch_end: 26
          update_interval: 4 
      no_impr: 6
      no_impr_thres: 0.2
      clip_gradient: 5
      stop_criterion: "accu"
    ```

* `enh_transform`: Feature configurations for enhancement/separation tasks. For example, using log spectrogram feature with cos-IPDs:
    ```yaml
    enh_transform:
      feats: "spectrogram-log-cmvn-ipd"
      frame_len: 512
      frame_hop: 256
      window: "hann"
      ipd_index: "0,1;0,2;0,3;0,4"
      cos_ipd: true
    ```

* `asr_transform`:  Feature configurations for ASR tasks. For examples, using log-fbank feature with spectral augumentation:
    ```yaml
    asr_transform:
      feats: "fbank-log-cmvn-aug"
      frame_len: 400
      frame_hop: 160
      window: "hamm"
      round_pow_of_two: true
      sr: 16000
      num_mels: 80
      norm_mean: True
      norm_var: True
      aug_prob: 0.5
    ```

The other options, e.g., batch_size, epochs, are treat as the script arguments. See `aps/scripts/train_{lm,ss,am}.py` and `aps/scripts/distributed_train_{ss,am}.py`.